{% load bootstrap4 %}
<script src="https://js.stripe.com/v3/"></script>
<style>
    form {
        width: 480px;
        margin: 20px 0;
    }

    .group {
        background: white;
        box-shadow: 0 7px 14px 0 rgba(49, 49, 93, 0.10), 0 3px 6px 0 rgba(0, 0, 0, 0.08);
        border-radius: 4px;
        margin-bottom: 20px;
    }

    label {
        position: relative;
        color: #8898AA;
        font-weight: 300;
        height: 40px;
        line-height: 40px;
        margin-left: 20px;
        display: flex;
        flex-direction: row;
    }

    .group label:not(:last-child) {
        border-bottom: 1px solid #F0F5FA;
    }

    label > span {
        width: 120px;
        text-align: right;
        margin-right: 30px;
    }

    .field {
        background: transparent;
        font-weight: 300;
        border: 0;
        color: #31325F;
        outline: none;
        flex: 1;
        padding-right: 10px;
        padding-left: 10px;
        cursor: text;
    }

    .field::-webkit-input-placeholder {
        color: #CFD7E0;
    }

    .field::-moz-placeholder {
        color: #CFD7E0;
    }

    #stripe_sub {
        float: left;
        display: block;
        background: #666EE8;
        color: white;
        box-shadow: 0 7px 14px 0 rgba(49, 49, 93, 0.10), 0 3px 6px 0 rgba(0, 0, 0, 0.08);
        border-radius: 4px;
        border: 0;
        margin-top: 20px;
        font-size: 15px;
        font-weight: 400;
        width: 100%;
        height: 40px;
        line-height: 38px;
        outline: none;
    }

    #stripe_sub:focus {
        background: #555ABF;
    }

    #stripe_sub:active {
        background: #43458B;
    }

    .outcome {
        float: left;
        width: 100%;
        padding-top: 8px;
        min-height: 24px;
        text-align: center;
    }

    .success,
    .error {
        display: none;
        font-size: 13px;
    }

    .success.visible,
    .error.visible {
        display: inline;
    }

    .error {
        color: #E4584C;
    }

    .success {
        color: #666EE8;
    }

    .success .token {
        font-weight: 500;
        font-size: 13px;
    }

</style>
<div class="mt-4">
    <div class="card mb-3">
        <div class="card-header">
            Your Subscription
        </div>
        <div class="card-body">
            <h5 class="card-title">
                {% if user_have_subscription %}
                    {{ last_subscription.mode|capfirst }} Subscription since {{ subscription_from }}
                {% else %}
                    You don't have any active subscription yet.
                {% endif %}
            </h5>
            <p class="card-text">
                {% if not user_have_subscription %}
                    Start changing your life. Now.
                {% endif %}
            </p>
            {% if user_have_subscription %}
                {% if trial %}
                    <small class="mt-2 d-block">
                        Your trail period will end on {{ subscription_to }}. Kindly use below
                        button to subscribe to one of our plan to continue using our services.
                    </small>
                    <button class="btn btn-dark_lila" data-toggle="modal" data-target=".plans_modal">
                        Subscribe now
                    </button>
                {% else %}
                    Next Billing Date: {{ subscription_to }}
                {% endif %}
                <a href="{% url 'profile_settings' %}#cancel_subscription"
                   class="link_no_underline dark_lila_link">
                    <small class="mt-2 d-block">Cancel my subscription</small>
                </a>
            {% else %}
                <button class="btn btn-dark_lila" data-toggle="modal" data-target=".plans_modal">Subscribe now</button>
            {% endif %}
        </div>
    </div>

    <div class="modal fade plans_modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Subscription</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h3>Plans</h3>
                    {% if plans %}
                        {% for plan in plans %}
                            {% if plan.active %}
                                <div class="card plan {% if forloop.first %}active_plan{% else %}inactive_plan{% endif %}"
                                     data-mode="{{ plan.interval }}ly"
                                     data-fee="{{ plan.amount }}"
                                     data-planid="{{ plan.id }}">
                                    <div class="card-body">
                                        <h5 class="card-title" style="text-transform: capitalize;">
                                            {{ plan.interval }}ly - {{ plan.amount }}/{{ plan.interval }}
                                        </h5>
                                        <p class="card-text">
                                            Billed {{ plan.interval }}ly.
                                        </p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="card">
                            <div class="card-body">
                                <p class="card-text">
                                    Sorry no plans are available yet
                                </p>
                            </div>
                        </div>
                    {% endif %}

                    {#                        <div class="card plan mt-3 inactive_plan" data-mode="quarterly" data-fee="19">#}
                    {#                            <div class="card-body">#}
                    {#                                <h5 class="card-title">Quarterly - $19/mo</h5>#}
                    {#                                <p class="card-text">#}
                    {#                                    Billed quarterly.#}
                    {#                                </p>#}
                    {#                            </div>#}
                    {#                        </div>#}
                    {#                        <div class="card plan inactive_plan mt-3" data-mode="annual" data-fee="18">#}
                    {#                            <div class="card-body">#}
                    {#                                <h5 class="card-title">Annual - $18/mo</h5>#}
                    {#                                <p class="card-text">#}
                    {#                                    Billed annually.#}
                    {#                                </p>#}
                    {#                            </div>#}
                    {#                        </div>#}

                    <div class="float-left text-uppercase mt-5">
                        <h5>Total</h5>
                    </div>
                    <div class="float-right mt-5">
                        <h5>$<span id="total_amount">{{ first_plan.amount }}</span></h5>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-dark_lila full_width btn-big show_payment_modal">
                        Continue with <span id="mode_in_button">{{ first_plan.interval }}</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade payment_modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Payment</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div id="selected_infos">

                        <div>
                            <h5>
                                Selected Plan:
                                <span id="selected_plan_name" class="text-uppercase"></span>
                            </h5>
                        </div>
                        <br>

                        <div class="float-left text-uppercase">
                            <h5>Total</h5>
                        </div>
                        <div class="float-right">
                            <h5>$<span id="selected_total_amount"></span></h5>
                        </div>
                        <form action="." method="POST" style="margin-top: 50px">
                            <input type="hidden" name="token"/>
                            <div class="group">
                                <label>
                                    <span>Card Number</span>
                                    <div id="card-number-element" class="field"></div>
                                </label>
                                <label>
                                    <span>Expiry Date</span>
                                    <div id="card-expiry-element" class="field"></div>
                                </label>
                                <label>
                                    <span>CVC</span>
                                    <div id="card-cvc-element" class="field"></div>
                                </label>
                            </div>
                            <button type="submit" id="stripe_sub">Subscribe</button>
                            <div class="outcome">
                                <div class="error"></div>
                                <div class="success">
                                    Success! Your Stripe token is <span class="token"></span>
                                </div>
                            </div>
                        </form>
                        <input type="hidden" id="stripe_plan_id" value="{{ first_plan.id }}">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% if client_token %}
    <script>
        {#var elements = stripe.elements();#}
        {#var form = document.getElementById('payment-form');#}
        {#// Custom styling can be passed to options when creating an Element.#}
        {#var style = {#}
        {#    base: {#}
        {#        // Add your base input styles here. For example:#}
        {#        fontSize: '16px',#}
        {#        color: "#32325d",#}
        {#    }#}
        {# };#}
        {##}
        {#// Create an instance of the card Element.#}
        {#var card = elements.create('card', {style: style});#}
        {##}
        {#// Add an instance of the card Element into the `card-element` <div>.#}
        {#card.mount('#card-element');#}
        {#form.addEventListener('submit', function (event) {#}
        {#    event.preventDefault();#}
        {#    console.log(card);#}
        {##}
        {#    stripe.createToken(card).then(function (result) {#}
        {#        if (result.error) {#}
        {#            // Inform the customer that there was an error.#}
        {#            var errorElement = document.getElementById('card-errors');#}
        {#            errorElement.textContent = result.error.message;#}
        {#        } else {#}
        {#            // Send the token to your server.#}
        {#            stripeTokenHandler(result.token);#}
        {#        }#}
        {#    });#}
        {# }); #}
        {##}
        {#function stripeTokenHandler(token) {#}
        {#    // Insert the token ID into the form so it gets submitted to the server#}
        {#    var form = document.getElementById('payment-form');#}
        {#    var hiddenInput = document.createElement('input');#}
        {#    hiddenInput.setAttribute('type', 'hidden');#}
        {#    hiddenInput.setAttribute('name', 'stripeToken');#}
        {#    hiddenInput.setAttribute('value', token.id);#}
        {#    form.appendChild(hiddenInput);#}
        {##}
        {#    // Submit the form#}
        {#    subscribeNow()#}
        {# }#}

        function calculate_total(fee, mode, plan_id) {
            $('#total_amount').text(fee);
            $('#mode_in_button').text(mode);
            $('#stripe_plan_id').val(plan_id);
        }

        function subscribeNow(token_id) {
            {% if client_token %}
                $.ajax({
                    url: '{% url "process_payment" %}',
                    type: 'post',
                    data: {
                        'stripeToken': token_id,
                        'plan_id': $('#stripe_plan_id').val(),
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    }
                }).done(function () {
                    $('#stripe_sub').attr("disabled", false);
                    window.dataLayer = window.dataLayer || [];
                    window.dataLayer.push({
                        'event': 'successfullySubscribed'
                    });
                    location.href = '{% url "profile_subscription" %}?payment_success=1';
                }).fail(function (err) {
                    $('#stripe_sub').attr("disabled", false);
                    location.href = '{% url "profile_subscription" %}?payment_failed=1&msg=' + err.responseText;
                });
            {% endif %}
        }

        $(function () {
            $('.plan').on('click', function () {

                var clicked_plan = $(this);

                $('.plan').each(function () {
                    $(this).removeClass('active_plan').addClass('inactive_plan');
                });

                clicked_plan.addClass('active_plan').removeClass('inactive_plan');

                calculate_total(parseFloat(clicked_plan.data('fee')), clicked_plan.data('mode'), clicked_plan.data('planid'));

            });

            // show show_payment_modal
            $('.show_payment_modal').on('click', function () {

                // populate infos in the second modal
                var total_amount = $('#total_amount').text();
                var mode_in_button = $('#mode_in_button').text();

                $('#selected_plan_name').text(mode_in_button);
                $('#selected_total_amount').text(total_amount);

                $('.plans_modal').modal('hide');
                $('.payment_modal').modal('show');
            });
        });


        var stripe = Stripe('{{ stripe_public_key }}');
        var elements = stripe.elements();

        var style = {
            base: {
                iconColor: '#666EE8',
                color: '#31325F',
                lineHeight: '40px',
                fontWeight: 300,
                fontFamily: 'Helvetica Neue',
                fontSize: '15px',

                '::placeholder': {
                    color: '#CFD7E0',
                },
            },
        };

        var cardNumberElement = elements.create('cardNumber', {
            style: style,
            placeholder: 'Custom card number placeholder',
        });
        cardNumberElement.mount('#card-number-element');

        var cardExpiryElement = elements.create('cardExpiry', {
            style: style,
            placeholder: 'Custom expiry date placeholder',
        });
        cardExpiryElement.mount('#card-expiry-element');

        var cardCvcElement = elements.create('cardCvc', {
            style: style,
            placeholder: 'Custom CVC placeholder',
        });
        cardCvcElement.mount('#card-cvc-element');


        function setOutcome(result) {
            var successElement = document.querySelector('.success');
            var errorElement = document.querySelector('.error');
            successElement.classList.remove('visible');
            errorElement.classList.remove('visible');

            if (result.token) {
                subscribeNow(result.token.id);
            } else if (result.error) {
                $('#stripe_sub').text('Subscribe');
                $('#stripe_sub').attr("disabled", false);
                errorElement.textContent = result.error.message;
                errorElement.classList.add('visible');
            }
        }

        cardNumberElement.on('change', function (event) {
            setOutcome(event);
        });

        document.querySelector('form').addEventListener('submit', function (e) {
            e.preventDefault();
            $('#stripe_sub').text('Processing payment...');
            $('#stripe_sub').attr("disabled", true);
            stripe.createToken(cardNumberElement).then(setOutcome);
        });

    </script>
{% endif %}